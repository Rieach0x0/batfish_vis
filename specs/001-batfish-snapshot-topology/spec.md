# Feature Specification: Batfish Snapshot & Topology Visualization

**Feature Branch**: `001-batfish-snapshot-topology`
**Created**: 2025-11-21
**Status**: Draft
**Input**: User description: "ネットワークコンフィグのファイルが格納されたフォルダを自動または手動で読み込ませ、batfishと連携してスナップショットを作成すること。その際に、ネットワークトポロジーの表示および各種コンフィグの検証が行なえるようにすること。"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Configuration Import & Snapshot Creation (Priority: P1)

ネットワークエンジニアがネットワーク機器の設定ファイル群を指定し、Batfishスナップショットを作成することで、後続の解析や可視化が可能になる。

**Why this priority**: スナップショットの作成はすべての解析・可視化機能の前提条件となる基盤機能。これがなければ他の機能は動作しない。

**Independent Test**: 設定ファイルが格納されたフォルダパスを指定してスナップショット作成を実行し、Batfishがスナップショットを正常に初期化できることで検証可能。

**Acceptance Scenarios**:

1. **Given** ネットワーク設定ファイル（Cisco IOS、Juniper JunOS、Arista EOS等）が格納されたフォルダが存在する、**When** ユーザーがフォルダパスを指定してスナップショット作成を実行する、**Then** Batfishがすべての設定ファイルを解析し、スナップショットが正常に作成される
2. **Given** 既存のスナップショットが存在する、**When** ユーザーが別のフォルダを指定して新しいスナップショットを作成する、**Then** 新しいスナップショットが作成され、以前のスナップショットは保持される
3. **Given** 不正な形式の設定ファイルが含まれるフォルダを指定した、**When** スナップショット作成を実行する、**Then** Batfishがパース可能なファイルのみでスナップショットを作成し、パース失敗したファイルとその理由を報告する

---

### User Story 2 - Network Topology Visualization (Priority: P2)

ネットワークエンジニアがスナップショットから自動生成されたネットワークトポロジー図を表示し、デバイス間の接続関係を視覚的に理解できる。

**Why this priority**: 設定ファイルから人間が理解しやすい形でネットワーク構造を把握することは、設定検証やトラブルシューティングの第一歩となる重要な機能。

**Independent Test**: スナップショット作成後にトポロジー可視化を実行し、Batfishが計算したLayer 3接続関係がグラフィカルに表示されることで検証可能。

**Acceptance Scenarios**:

1. **Given** 有効なBatfishスナップショットが存在する、**When** ユーザーがトポロジー可視化を実行する、**Then** すべてのネットワークデバイスがノードとして表示され、Layer 3エッジが線で接続される
2. **Given** トポロジー図が表示されている、**When** ユーザーが特定のノード（デバイス）をクリックする、**Then** そのデバイスの詳細情報（ホスト名、ベンダー、インターフェース一覧）が表示される
3. **Given** トポロジー図が表示されている、**When** ユーザーがズーム・パン操作を実行する、**Then** 表示倍率や表示位置が変更され、大規模ネットワークでも詳細を確認できる
4. **Given** トポロジー図が表示されている、**When** ユーザーがトポロジー図をエクスポートする、**Then** SVGまたはPNG形式でファイルが保存され、ドキュメント作成に利用できる

---

### User Story 3 - Configuration Verification (Priority: P3)

ネットワークエンジニアがスナップショットに対してBatfishの検証クエリを実行し、設定の正当性や到達性を確認できる。

**Why this priority**: トポロジー可視化の次に重要なのは、設定が意図通りに動作するかを検証すること。ACL、ルーティング、到達性の問題を事前に発見できる。

**Independent Test**: スナップショット作成後に検証クエリ（例: reachability、ACL検証）を実行し、Batfishが構造化された検証結果を返すことで検証可能。

**Acceptance Scenarios**:

1. **Given** 有効なBatfishスナップショットが存在する、**When** ユーザーが到達性検証（reachability）を実行する、**Then** 指定された送信元から宛先へのパケットフローが成功するか失敗するかが明示される
2. **Given** 有効なBatfishスナップショットが存在する、**When** ユーザーがACLフィルタ検証を実行する、**Then** 特定のパケットがどのACLルールにマッチするか、許可/拒否が判定される
3. **Given** 有効なBatfishスナップショットが存在する、**When** ユーザーがルーティング情報検証を実行する、**Then** 各デバイスのルーティングテーブルとネクストホップ情報が表示される
4. **Given** 検証結果にエラーや設定問題が含まれる、**When** 検証結果が表示される、**Then** 問題の原因となった設定ファイル名と行番号が提示される

---

### Edge Cases

- 設定ファイルが1つもパース可能でない場合、スナップショット作成は失敗し、具体的なエラーメッセージを表示する
- 100台以上のデバイスを含む大規模ネットワークのトポロジー可視化で、レイアウトアルゴリズムが過度に時間を消費する場合、プログレスバーを表示し、タイムアウト設定を提供する
- Batfishコンテナが起動していない、または到達不可能な場合、明確なエラーメッセージと接続確認手順を表示する
- 複数のスナップショットが存在する場合、現在アクティブなスナップショットを明示し、切り替え機能を提供する
- ネットワーク設定に未サポートベンダーの機器が含まれる場合、Batfishがサポートするベンダー一覧と、サポート外ファイルの扱いを説明する

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: システムはユーザーが指定したフォルダ内のすべてのネットワーク設定ファイルを読み込み、Batfishコンテナに送信してスナップショットを作成できなければならない
- **FR-002**: システムはスナップショット作成時に、Batfishが各設定ファイルを正常にパースできたか、エラーが発生したかを報告しなければならない
- **FR-003**: システムはBatfishコンテナの稼働状態を確認し、コンテナが応答不可の場合は明確なエラーメッセージを表示しなければならない
- **FR-004**: システムはBatfishスナップショットからLayer 3トポロジー情報を取得し、デバイスをノード、接続をエッジとしてグラフィカルに表示しなければならない
- **FR-005**: システムはトポロジー可視化において、複数のレイアウトアルゴリズム（force-directed、階層型など）を提供しなければならない
- **FR-006**: システムはトポロジー図に対してインタラクティブ操作（ズーム、パン、ノード選択、詳細表示）を提供しなければならない
- **FR-007**: システムはトポロジー図を静的画像形式（SVG、PNG）でエクスポート可能でなければならない
- **FR-008**: システムはBatfishの検証クエリ（到達性検証、ACL検証、ルーティング検証）を実行し、結果を構造化して表示しなければならない
- **FR-009**: システムは検証結果に含まれるエラーや警告に対して、該当する設定ファイル名と行番号をトレーサブルに提示しなければならない
- **FR-010**: システムは作成されたスナップショットを永続化し、複数のスナップショットを管理（一覧表示、切り替え、削除）できなければならない
- **FR-011**: システムはBatfishとの全インタラクション（スナップショット作成、クエリ実行）を構造化ログとして記録しなければならない
- **FR-012**: システムはフォルダ選択を手動（パス入力またはファイルブラウザ）およびコマンドライン引数による自動指定の両方をサポートしなければならない

### Key Entities

- **Snapshot（スナップショット）**: Batfishが解析したネットワーク設定の不変なコピー。スナップショット名、作成日時、含まれる設定ファイル数、Batfishバージョンを含む
- **Device（デバイス）**: ネットワーク機器を表す論理エンティティ。ホスト名、ベンダー、機器タイプ、インターフェース一覧を含む
- **Interface（インターフェース）**: デバイスのネットワークインターフェース。名前、IPアドレス、VLAN、ステータス（active/inactive）を含む
- **Edge（エッジ）**: デバイス間のLayer 3接続。送信元デバイス・インターフェース、宛先デバイス・インターフェースのペアを含む
- **Verification Result（検証結果）**: Batfishクエリの実行結果。クエリタイプ、パラメータ、成功/失敗判定、詳細メッセージ、該当設定ファイル情報を含む

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: ユーザーは10台のデバイス設定を含むフォルダから2分以内にBatfishスナップショットを作成できる
- **SC-002**: トポロジー可視化は50台以下のデバイスで5秒以内に表示が完了する
- **SC-003**: トポロジー図はBatfishのLayer 3トポロジークエリ結果と100%一致する（ノード数、エッジ数、接続関係）
- **SC-004**: 検証クエリ結果は設定ファイル名と行番号を含み、ユーザーが問題箇所を直接確認できる
- **SC-005**: システムは100台以上のデバイスを含むスナップショットを作成でき、タイムアウトなく完了する
- **SC-006**: Batfishコンテナとの接続失敗時、ユーザーは5秒以内に明確なエラーメッセージと対処方法を確認できる
- **SC-007**: ユーザーの90%が初回利用時にフォルダ選択からスナップショット作成まで追加説明なしで完了できる
- **SC-008**: トポロジー図のエクスポート機能により、ドキュメント作成時間が手動作図と比較して80%短縮される

## Assumptions

- Batfishコンテナは別途起動済みであり、デフォルトポート（9996/9997）で接続可能であると仮定する
- ネットワーク設定ファイルは標準的なベンダーフォーマット（Cisco IOS、Juniper JunOS、Arista EOS等）であると仮定する
- ユーザーはネットワークエンジニアであり、基本的なネットワーク概念（Layer 3、VLAN、ACL、ルーティング）を理解していると仮定する
- トポロジー可視化はWebブラウザまたはデスクトップアプリケーションで表示されると仮定する（実装詳細は計画フェーズで決定）
- 設定ファイルのサイズは通常数KB～数MBの範囲であり、極端に大きなファイル（100MB超）は想定しない
